{% extends 'dashboard/base.html' %}
{% load crispy_forms_tags %}
{% block content %}
{% include 'dashboard/top.html' %}
{% load mptt_tags %}
    <div class="row my-4">
        <div class="col-xl-3">
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-#">
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}
            <div class="card p-3" data-aos="zoom-out-right" data-aos-delay="200">
                <h2>新商品追加</h2>
                <hr>
                <form method="POST" enctype='multipart/form-data'>
                    {% csrf_token %}
                    {{ form | crispy }}
                    {% for choice in drive_nodes.choices %}
                        {{ choice }}
                    {% endfor %}
                    <br>
                    <input class="btn btn-success btn-block" type="submit" value="Add">
                </form>
            </div>
        </div>
        <div class="col-xl-9" data-aos="slide-left" data-aos-delay="500">
            <table class="table bg-white">
                <thead class="bg-info text-white">
                    <tr>
                        <th scope="col">お名前</th>
                        <th scope="col">カテゴリー</th>
                        <th scope="col">&nbsp;数量</th>
                        <th scope="col">単価</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td class="editable" data-id="{{ item.id}}"data-type="name">{{ item.name }}</td>
                        <td class="d-flex">{{ item.category.parent }}|({{ item.category.name }})</td>
                        <td >
                        <a class="minus" href="{% url 'item_delete' item.pk %}"><i class="fa fa-minus"></i></a>
                        {{ item.quantity }}
                        <a href="{% url 'item_add' item.pk %}"><i class="fa fa-plus"></i></a>
                        </td>
                        <td class="editable" data-id="{{ item.id}}"data-type="price">{{ item.price }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
    $(document).ready(function(){
        $(document).on("dblclick", ".editable", function(){
            var value = $(this).text();
            var input = "<input type='text' class='input-data' value='"+value+"' class='form-control'>";
            $(this).html(input);
            $('input',this).focus();
            $(this).removeClass("editable");
        })
        $(document).on("blur", ".input-data", function(){
            var value = $(this).val();
            var td = $(this).parent("td");
            $(this).remove();
            td.html(value);
            td.addClass("editable");
            var type = td.data("type");
            sendToServer(td.data("id"), value, type);
        })
        $(document).on("keypress", ".input-data", function(e){
            var key = e.which;
            if(key==13){
                var value = $(this).val();
                var td = $(this).parent("td");
                $(this).remove();
                td.html(value);
                td.addClass("editable");
                var type = td.data("type");
                sendToServer(td.data("id"), value, type);
            }
        })
        function sendToServer(id, value, type){
            console.log(id);
            console.log(value);
            console.log(type);
            $.ajax({
                url:"https://kangsm.pythonanywhere.com/dashboard/item_save/",
                type: "POST",
                data:{id:id, type:type, value:value},
            })
            .done(function(response){
                console.log(response);
            })
            .fail(function(){
                console.log("Error");
            })
        }
    });
    $(document).on('click', '.minus', function(){
    return confirm('在庫を減らしますか？「ゼロ：商品非表示」｜「ゼロ以下：削除」');
    })

    </script>
{% endblock content %}